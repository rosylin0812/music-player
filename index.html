<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1DB954">
    <title>Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Circular', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; overflow: hidden; }
        
        .bg-gradient-dark { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%); }
        .bg-gradient-light { background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 50%, #d4d4d4 100%); }
        
        .card-dark { 
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .card-light { 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1DB954 0%, #1ed760 100%);
            box-shadow: 0 4px 15px rgba(29, 185, 84, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(29, 185, 84, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
        
        .sidebar-dark { 
            background: linear-gradient(180deg, #000000 0%, #0a0a0a 100%);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .sidebar-light { 
            background: linear-gradient(180deg, #ffffff 0%, #f8f8f8 100%);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .playlist-item {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .playlist-item:hover {
            transform: translateX(4px);
        }
        
        .song-item {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .song-item:hover {
            transform: scale(1.01);
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        
        input[type="range"]::-webkit-slider-track {
            background: rgba(255, 255, 255, 0.3);
            height: 4px;
            border-radius: 2px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #1DB954;
            cursor: pointer;
            margin-top: -5px;
        }
        
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -100%; top: 0; bottom: 0; width: 75%; max-width: 280px; z-index: 50; transition: left 0.3s; }
            .sidebar.open { left: 0; }
            .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 40; backdrop-filter: blur(4px); }
            .overlay.open { display: block; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script>
        const { useState, useEffect, useRef } = React;
        const PRIMARY = '#1DB954';

        // IndexedDB
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open('MusicDB', 1);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve(req.result);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('playlists')) db.createObjectStore('playlists', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('songs')) db.createObjectStore('songs', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings', { keyPath: 'key' });
                };
            });
        };

        const DB = {
            async save(store, data) {
                const db = await initDB();
                const tx = db.transaction(store, 'readwrite');
                tx.objectStore(store).put(data);
                return new Promise((res, rej) => { tx.oncomplete = res; tx.onerror = rej; });
            },
            async get(store, key) {
                const db = await initDB();
                const tx = db.transaction(store, 'readonly');
                const req = tx.objectStore(store).get(key);
                return new Promise((res) => { req.onsuccess = () => res(req.result); });
            },
            async getAll(store) {
                const db = await initDB();
                const tx = db.transaction(store, 'readonly');
                const req = tx.objectStore(store).getAll();
                return new Promise((res) => { req.onsuccess = () => res(req.result || []); });
            },
            async delete(store, key) {
                const db = await initDB();
                const tx = db.transaction(store, 'readwrite');
                tx.objectStore(store).delete(key);
                return new Promise((res, rej) => { tx.oncomplete = res; tx.onerror = rej; });
            }
        };

        function MusicPlayer() {
            const [playlists, setPlaylists] = useState([]);
            const [activePlaylist, setActivePlaylist] = useState(null);
            const [currentSong, setCurrentSong] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);
            const [repeat, setRepeat] = useState(false);
            const [progress, setProgress] = useState(0);
            const [volume, setVolume] = useState(80);
            const [darkMode, setDarkMode] = useState(true);
            const [searchQuery, setSearchQuery] = useState('');
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [showModal, setShowModal] = useState(null);
            const [modalInput, setModalInput] = useState('');
            const [loading, setLoading] = useState(true);
            
            const audioRef = useRef(null);
            const fileInputRef = useRef(null);

            const bgMain = darkMode ? 'bg-gradient-dark' : 'bg-gradient-light';
            const sidebar = darkMode ? 'sidebar-dark' : 'sidebar-light';
            const card = darkMode ? 'card-dark' : 'card-light';
            const txt = darkMode ? 'text-white' : 'text-gray-900';
            const txtMuted = darkMode ? 'text-gray-400' : 'text-gray-600';

            useEffect(() => { loadData(); }, []);

            const loadData = async () => {
                try {
                    const [lists, mode, vol] = await Promise.all([
                        DB.getAll('playlists'),
                        DB.get('settings', 'darkMode'),
                        DB.get('settings', 'volume')
                    ]);
                    if (lists) setPlaylists(lists);
                    if (mode) setDarkMode(mode.value);
                    if (vol) setVolume(vol.value);
                } catch (e) {
                    console.error('Load error:', e);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (!loading) playlists.forEach(p => DB.save('playlists', p));
            }, [playlists, loading]);

            useEffect(() => {
                if (!loading) DB.save('settings', { key: 'darkMode', value: darkMode });
            }, [darkMode, loading]);

            useEffect(() => {
                if (!loading) DB.save('settings', { key: 'volume', value: volume });
            }, [volume, loading]);

            useEffect(() => {
                if (audioRef.current && currentSong) {
                    audioRef.current.src = currentSong.url;
                    audioRef.current.load();
                    if (isPlaying) audioRef.current.play().catch(() => setIsPlaying(false));
                }
            }, [currentSong]);

            useEffect(() => {
                if (audioRef.current && currentSong) {
                    if (isPlaying) audioRef.current.play().catch(() => setIsPlaying(false));
                    else audioRef.current.pause();
                }
            }, [isPlaying]);

            useEffect(() => {
                if (audioRef.current) audioRef.current.volume = volume / 100;
            }, [volume]);

            const createPlaylist = () => {
                setModalInput('');
                setShowModal('create');
            };

            const handleCreate = () => {
                if (modalInput.trim()) {
                    setPlaylists([...playlists, { id: Date.now(), name: modalInput.trim(), songs: [] }]);
                    setActivePlaylist(Date.now());
                    setShowModal(null);
                    setSidebarOpen(false);
                }
            };

            const handleFileUpload = async (e) => {
                if (!activePlaylist) return alert('Select a playlist first');
                const files = Array.from(e.target.files);
                const playlist = playlists.find(p => p.id === activePlaylist);
                if (!playlist) return;

                for (const file of files) {
                    const id = Date.now() + Math.random();
                    const song = { id, name: file.name.replace(/\.[^/.]+$/, ''), isUrl: false };
                    await DB.save('songs', { id, blob: file });
                    playlist.songs.push(song);
                }
                setPlaylists([...playlists]);
            };

            const handleUrlSubmit = () => {
                if (!modalInput.trim() || !activePlaylist) return;
                try { new URL(modalInput); } catch { return alert('Invalid URL'); }
                const playlist = playlists.find(p => p.id === activePlaylist);
                if (!playlist) return;
                playlist.songs.push({
                    id: Date.now() + Math.random(),
                    name: modalInput.split('/').pop().split('?')[0] || 'Audio',
                    url: modalInput,
                    isUrl: true
                });
                setPlaylists([...playlists]);
                setModalInput('');
                setShowModal(null);
            };

            const playSong = async (song, pid) => {
                if (song.isUrl) {
                    setCurrentSong({ ...song, playlistId: pid });
                } else {
                    const data = await DB.get('songs', song.id);
                    if (data?.blob) {
                        setCurrentSong({ ...song, playlistId: pid, url: URL.createObjectURL(data.blob) });
                    }
                }
                setIsPlaying(true);
            };

            const deleteItem = async (type, id, pid) => {
                if (type === 'playlist') {
                    const p = playlists.find(x => x.id === id);
                    if (p) for (const s of p.songs) if (!s.isUrl) await DB.delete('songs', s.id);
                    setPlaylists(playlists.filter(x => x.id !== id));
                    if (activePlaylist === id) setActivePlaylist(null);
                } else {
                    const p = playlists.find(x => x.id === pid);
                    if (p) {
                        const s = p.songs.find(x => x.id === id);
                        if (s && !s.isUrl) await DB.delete('songs', s.id);
                        p.songs = p.songs.filter(x => x.id !== id);
                        setPlaylists([...playlists]);
                    }
                }
                setShowModal(null);
            };

            const exportData = () => {
                const blob = new Blob([JSON.stringify(playlists, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `music-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if (Array.isArray(data)) setPlaylists([...playlists, ...data]);
                    } catch { alert('Invalid file'); }
                };
                reader.readAsText(file);
            };

            const formatTime = (s) => {
                if (!s || isNaN(s)) return '0:00';
                const m = Math.floor(s / 60);
                const sec = Math.floor(s % 60);
                return `${m}:${sec.toString().padStart(2, '0')}`;
            };

            const current = playlists.find(p => p.id === activePlaylist);
            const filtered = playlists.filter(p => 
                p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                p.songs.some(s => s.name.toLowerCase().includes(searchQuery.toLowerCase()))
            );

            if (loading) {
                return React.createElement('div', { className: `h-screen flex items-center justify-center ${bgMain} ${txt}` },
                    React.createElement('div', { className: 'text-center' },
                        React.createElement('div', { className: 'text-3xl font-bold mb-2' }, 'Music Player'),
                        React.createElement('div', { className: txtMuted }, 'Loading your library...')
                    )
                );
            }

            return React.createElement('div', { className: `h-screen flex flex-col ${bgMain} ${txt}` },
                React.createElement('div', { className: `overlay ${sidebarOpen ? 'open' : ''}`, onClick: () => setSidebarOpen(false) }),

                React.createElement('div', { className: 'flex flex-1 overflow-hidden' },
                    // Sidebar
                    React.createElement('div', { className: `sidebar ${sidebarOpen ? 'open' : ''} md:relative w-64 ${sidebar} p-6 flex flex-col gap-6` },
                        React.createElement('div', { className: 'flex items-center justify-between' },
                            React.createElement('div', { className: 'text-2xl font-bold tracking-tight' }, 'Music'),
                            React.createElement('div', { className: 'flex gap-2' },
                                React.createElement('button', {
                                    onClick: () => setDarkMode(!darkMode),
                                    className: `p-2.5 rounded-full ${card} hover:scale-110 transition-all duration-300 ${txt}`
                                }, darkMode ? 
                                    React.createElement('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z' })
                                    )
                                    : 
                                    React.createElement('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z' })
                                    )
                                ),
                                React.createElement('button', {
                                    onClick: () => setSidebarOpen(false),
                                    className: `md:hidden p-2.5 rounded-full ${card} hover:scale-110 transition-all duration-300`
                                }, 
                                    React.createElement('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M6 18L18 6M6 6l12 12' })
                                    )
                                )
                            )
                        ),

                        React.createElement('button', {
                            onClick: createPlaylist,
                            className: 'btn-primary px-6 py-3.5 rounded-full font-bold text-white text-center'
                        }, 'Create Playlist'),

                        React.createElement('button', {
                            onClick: () => setShowModal('export'),
                            className: `btn-secondary px-6 py-3.5 rounded-full font-semibold ${txt} text-center`
                        }, 'Backup & Share'),

                        React.createElement('input', {
                            type: 'text',
                            placeholder: 'Search playlists...',
                            value: searchQuery,
                            onChange: (e) => setSearchQuery(e.target.value),
                            className: `px-4 py-3 ${card} rounded-xl outline-none ${txt} placeholder-gray-500`
                        }),

                        React.createElement('div', { className: 'flex-1 overflow-y-auto scrollbar-hide' },
                            React.createElement('div', { className: `text-xs ${txtMuted} mb-3 uppercase font-bold tracking-wider` }, 'Your Library'),
                            React.createElement('div', { className: 'space-y-2' },
                                filtered.map(p => React.createElement('div', {
                                    key: p.id,
                                    onClick: () => { setActivePlaylist(p.id); setSidebarOpen(false); },
                                    className: `playlist-item p-4 rounded-xl cursor-pointer ${activePlaylist === p.id ? card : 'hover:bg-white hover:bg-opacity-5'}`,
                                    style: activePlaylist === p.id ? { borderLeft: `4px solid ${PRIMARY}` } : {}
                                },
                                    React.createElement('div', { className: 'flex justify-between items-center' },
                                        React.createElement('div', { className: 'flex-1 min-w-0' },
                                            React.createElement('div', {
                                                className: 'font-bold truncate text-base',
                                                style: activePlaylist === p.id ? { color: PRIMARY } : {}
                                            }, p.name),
                                            React.createElement('div', { className: `text-sm ${txtMuted} mt-0.5` }, `${p.songs.length} tracks`)
                                        ),
                                        React.createElement('button', {
                                            onClick: (e) => { e.stopPropagation(); setShowModal({ type: 'delete-playlist', id: p.id }); },
                                            className: `opacity-0 group-hover:opacity-100 p-2 rounded-lg hover:bg-red-500 hover:bg-opacity-20 transition-all ${txtMuted} hover:text-red-400`
                                        }, 
                                            React.createElement('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                                React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16' })
                                            )
                                        )
                                    )
                                ))
                            )
                        )
                    ),

                    // Main Content
                    React.createElement('div', { className: 'flex-1 overflow-y-auto pb-32' },
                        React.createElement('div', { className: `md:hidden sticky top-0 ${card} backdrop-blur-xl p-4 flex items-center gap-4 z-10` },
                            React.createElement('button', { 
                                onClick: () => setSidebarOpen(true),
                                className: `p-2 rounded-lg ${card}`
                            }, 
                                React.createElement('svg', { className: 'w-6 h-6', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                    React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 6h16M4 12h16M4 18h16' })
                                )
                            ),
                            React.createElement('div', { className: 'flex-1 font-bold text-lg' }, current?.name || 'Music Player')
                        ),

                        current ? React.createElement('div', { className: 'p-6 md:p-10' },
                            React.createElement('div', { className: 'mb-10' },
                                React.createElement('div', { className: 'flex flex-col md:flex-row items-start md:items-end gap-6' },
                                    React.createElement('div', {
                                        className: `w-56 h-56 rounded-2xl ${card} flex items-center justify-center shadow-2xl`,
                                        style: { 
                                            background: `linear-gradient(135deg, ${PRIMARY}40 0%, ${PRIMARY}20 100%)`
                                        }
                                    },
                                        React.createElement('svg', { className: 'w-24 h-24 opacity-60', fill: 'currentColor', viewBox: '0 0 20 20' },
                                            React.createElement('path', { d: 'M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z' })
                                        )
                                    ),
                                    React.createElement('div', { className: 'flex-1' },
                                        React.createElement('div', { className: `text-sm ${txtMuted} uppercase mb-2 font-bold tracking-wider` }, 'Playlist'),
                                        React.createElement('h1', { className: 'text-4xl md:text-6xl lg:text-7xl font-black mb-4 tracking-tight' }, current.name),
                                        React.createElement('div', { className: `text-base ${txtMuted} font-medium` }, `${current.songs.length} tracks`)
                                    )
                                )
                            ),

                            React.createElement('div', { className: 'flex flex-wrap gap-4 mb-8' },
                                React.createElement('button', {
                                    onClick: () => fileInputRef.current?.click(),
                                    className: 'btn-primary px-8 py-4 rounded-full font-bold text-white flex items-center gap-3'
                                }, 
                                    React.createElement('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12' })
                                    ),
                                    'Upload Files'
                                ),
                                React.createElement('button', {
                                    onClick: () => { setModalInput(''); setShowModal('url'); },
                                    className: `btn-secondary px-8 py-4 rounded-full font-bold ${txt} flex items-center gap-3`
                                }, 
                                    React.createElement('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                        React.createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1' })
                                    ),
                                    'Add URL'
                                )
                            ),

                            current.songs.length > 0 ? React.createElement('div', { className: 'space-y-2' },
                                current.songs.map((s, i) => React.createElement('div', {
                                    key: s.id,
                                    onClick: () => playSong(s, current.id),
                                    className: `song-item group p-4 rounded-xl ${card} cursor-pointer ${currentSong?.id === s.id ? 'ring-2' : ''}`,
                                    style: currentSong?.id === s.id ? { ringColor: PRIMARY, backgroundColor: `${PRIMARY}15` } : {}
                                },
                                    React.createElement('div', { className: 'flex items-center gap-4' },
                                        React.createElement('div', { 
                                            className: `flex items-center justify-center w-10 h-10 rounded-lg font-bold`,
                                            style: currentSong?.id === s.id && isPlaying ? { backgroundColor: PRIMARY, color: '#fff' } : { backgroundColor: darkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)' }
                                        },
                                            currentSong?.id === s.id && isPlaying ? 
                                                React.createElement('svg', { className: 'w-4 h-4', fill: 'currentColor', viewBox: '0 0 20 20' },
                                                    React.createElement('path', { d: 'M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z' })
                                                )
                                                : i + 1
                                        ),
                                        React.createElement('div', { className: 'flex-1 min-w-0' },
                                            React.createElement('div', {
                                                className: 'font-bold truncate text-base',
                                                style: currentSong?.id === s.id ? { color: PRIMARY } : {}
                                            }, s.name),
                                            React
