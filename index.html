<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2E8B57">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Music Player">
    <link rel="icon" type="image/svg+xml" href="icon-final.svg">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Music Player v14 - Safari Fix</title>

<!-- VConsole Mobile DevTools -->
<script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
<script>
    var vConsole = new window.VConsole();
    console.log('üîß VConsole loaded! Look for green button in bottom-right.');
</script>

<style>
    * { 
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
    }
    
    html, body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        overflow: hidden;
        -webkit-font-smoothing: antialiased;
        touch-action: manipulation;
        -webkit-text-size-adjust: 100%;
        width: 100%;
        height: 100%;
        position: fixed;
        margin: 0;
        padding: 0;
        background: #000000;
    }
    
    #root {
        width: 100%;
        height: 100%;
        background: #000000;
    }
    
    .bg-dark { 
        background: #000000; 
        color: #ffffff;
    }
    
    .loading-overlay {
        position: fixed;
        inset: 0;
        background: #000000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        color: #ffffff;
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top-color: #1DB954;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Simple button styles for testing */
    .btn-primary {
        background: linear-gradient(135deg, #1DB954 0%, #1ed760 100%);
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin: 10px;
    }
    
    .debug-panel {
        background: rgba(30, 30, 40, 0.98);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 20px;
        margin: 20px;
        color: #ffffff;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        max-width: 500px;
    }
    
    .debug-item {
        margin: 8px 0;
        padding: 4px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

</head>
<body>
    <div id="root"></div>

<script>
    const { useState, useEffect, useRef } = React;
    
    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    const firebaseConfig = {
      apiKey: "AIzaSyAA6AeCrTWe8_8sYTdnHffNuaPbbmUIftQ",
      authDomain: "fan-bai-song-player.firebaseapp.com",
      databaseURL: "https://fan-bai-song-player-default-rtdb.firebaseio.com",
      projectId: "fan-bai-song-player",
      storageBucket: "fan-bai-song-player.firebasestorage.app",
      messagingSenderId: "929176647542",
      appId: "1:929176647542:web:d0a385183a71ca358fec57"
    };

    // Initialize Firebase
    let firebaseApp, firebaseDB, firebaseAuth;
    let isFirebaseConfigured = false;

    try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        firebaseDB = firebase.database();
        firebaseAuth = firebase.auth();
        
        // Set persistence to LOCAL
        firebaseAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                console.log('‚úÖ Firebase auth persistence set to LOCAL');
            })
            .catch((error) => {
                console.error('‚ùå Error setting Firebase persistence:', error);
            });
        
        isFirebaseConfigured = true;
        console.log('‚úÖ Firebase initialized successfully');
    } catch (error) {
        console.error('‚ùå Firebase initialization error:', error);
        isFirebaseConfigured = false;
    }

    // ============================================
    // SAFARI-COMPATIBLE FIREBASE AUTH
    // ============================================
    
    /**
     * SAFARI FIX: Use REDIRECT flow instead of POPUP
     * Safari blocks popups aggressively, so we MUST use redirect
     */
    const signInWithGoogle = async () => {
        if (!isFirebaseConfigured || !firebaseAuth) {
            console.error('‚ùå Firebase not configured');
            alert('Firebase not configured');
            return null;
        }
        
        try {
            console.log('üîê Starting Google sign-in for Safari...');
            console.log('üåê Browser:', navigator.userAgent);
            
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/userinfo.profile');
            provider.addScope('https://www.googleapis.com/auth/userinfo.email');
            
            // SAFARI FIX: Always use redirect on mobile/Safari
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            
            if (isMobile || isSafari) {
                console.log('üì± Mobile/Safari detected - using REDIRECT flow');
                console.log('üîÑ Redirecting to Google sign-in...');
                
                // Store a flag to know we initiated sign-in
                localStorage.setItem('firebaseSignInInitiated', 'true');
                
                // Use redirect (this will reload the page)
                await firebaseAuth.signInWithRedirect(provider);
                
                // Code after this won't run because page redirects
                return null;
            } else {
                // Desktop Chrome/Firefox - try popup first
                console.log('üíª Desktop detected - trying POPUP flow');
                try {
                    const result = await firebaseAuth.signInWithPopup(provider);
                    console.log('‚úÖ Popup sign-in successful!');
                    return result.user;
                } catch (popupError) {
                    console.warn('‚ö†Ô∏è Popup failed, falling back to redirect:', popupError.code);
                    localStorage.setItem('firebaseSignInInitiated', 'true');
                    await firebaseAuth.signInWithRedirect(provider);
                    return null;
                }
            }
        } catch (error) {
            console.error('‚ùå Sign-in error:', error);
            console.error('Error code:', error.code);
            console.error('Error message:', error.message);
            alert(`Sign-in failed: ${error.message}`);
            return null;
        }
    };

    function TestApp() {
        const [firebaseUser, setFirebaseUser] = useState(null);
        const [loading, setLoading] = useState(true);
        const [debugInfo, setDebugInfo] = useState({});
        const [checkingRedirect, setCheckingRedirect] = useState(false);
        
        // Handle redirect result on page load
        useEffect(() => {
            if (!isFirebaseConfigured || !firebaseAuth) {
                setLoading(false);
                setDebugInfo(prev => ({
                    ...prev,
                    error: 'Firebase not configured'
                }));
                return;
            }
            
            const handleRedirectResult = async () => {
                try {
                    console.log('üîç Checking for redirect result...');
                    setCheckingRedirect(true);
                    
                    const result = await firebaseAuth.getRedirectResult();
                    console.log('üì• Redirect result:', result);
                    
                    if (result && result.user) {
                        console.log('‚úÖ REDIRECT SIGN-IN SUCCESSFUL!');
                        console.log('‚úÖ User UID:', result.user.uid);
                        console.log('‚úÖ User email:', result.user.email);
                        console.log('‚úÖ User name:', result.user.displayName);
                        
                        setFirebaseUser(result.user);
                        
                        // Clear the sign-in flag
                        localStorage.removeItem('firebaseSignInInitiated');
                        
                        setDebugInfo(prev => ({
                            ...prev,
                            redirectSuccess: true,
                            uid: result.user.uid,
                            email: result.user.email,
                            name: result.user.displayName
                        }));
                        
                        alert(`‚úÖ Sign-in successful!\n\nWelcome ${result.user.displayName}!`);
                    } else {
                        console.log('‚ÑπÔ∏è No redirect result');
                        
                        // Check if we were expecting a redirect
                        const wasSigningIn = localStorage.getItem('firebaseSignInInitiated');
                        if (wasSigningIn) {
                            console.log('‚ö†Ô∏è Sign-in was initiated but no result returned');
                            console.log('‚ö†Ô∏è User may have cancelled or error occurred');
                            localStorage.removeItem('firebaseSignInInitiated');
                        }
                        
                        setDebugInfo(prev => ({
                            ...prev,
                            noRedirectResult: true
                        }));
                    }
                } catch (error) {
                    console.error('‚ùå Redirect result error:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    setDebugInfo(prev => ({
                        ...prev,
                        redirectError: error.message,
                        errorCode: error.code
                    }));
                    
                    // Clear the sign-in flag on error
                    localStorage.removeItem('firebaseSignInInitiated');
                } finally {
                    setCheckingRedirect(false);
                }
            };
            
            handleRedirectResult();
        }, []);
        
        // Listen to auth state changes
        useEffect(() => {
            if (!isFirebaseConfigured || !firebaseAuth) {
                return;
            }
            
            const unsubscribe = firebaseAuth.onAuthStateChanged((user) => {
                console.log('üîî Auth state changed:', user ? `User: ${user.uid}` : 'No user');
                
                if (user) {
                    console.log('‚úÖ Firebase user detected');
                    console.log('   UID:', user.uid);
                    console.log('   Email:', user.email);
                    console.log('   Display Name:', user.displayName);
                    console.log('   Is Anonymous:', user.isAnonymous);
                    
                    if (!user.isAnonymous) {
                        setFirebaseUser(user);
                        setDebugInfo(prev => ({
                            ...prev,
                            authStateUser: true,
                            uid: user.uid,
                            email: user.email,
                            isAnonymous: false
                        }));
                    } else {
                        console.log('‚ö†Ô∏è User is anonymous - not setting');
                        setDebugInfo(prev => ({
                            ...prev,
                            authStateUser: true,
                            isAnonymous: true
                        }));
                    }
                } else {
                    console.log('‚ùå No Firebase user');
                    setFirebaseUser(null);
                    setDebugInfo(prev => ({
                        ...prev,
                        authStateUser: false
                    }));
                }
                
                setLoading(false);
            });
            
            return () => unsubscribe();
        }, []);
        
        // Update debug info
        useEffect(() => {
            setDebugInfo(prev => ({
                ...prev,
                timestamp: new Date().toLocaleTimeString(),
                firebaseConfigured: isFirebaseConfigured,
                hasFirebaseUser: !!firebaseUser,
                userAgent: navigator.userAgent,
                isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
                isMobile: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)
            }));
        }, [firebaseUser]);
        
        if (loading || checkingRedirect) {
            return React.createElement('div', { className: 'loading-overlay' },
                React.createElement('div', { className: 'spinner' }),
                React.createElement('div', { style: { marginTop: '20px', fontSize: '18px' } }, 
                    checkingRedirect ? 'Checking for sign-in...' : 'Loading...'
                ),
                React.createElement('div', { style: { marginTop: '8px', fontSize: '14px', opacity: 0.7 } }, 
                    'Please wait'
                )
            );
        }
        
        return React.createElement('div', { 
            className: 'bg-dark',
            style: { 
                minHeight: '100vh', 
                padding: '20px',
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                justifyContent: 'center'
            } 
        },
            // Title
            React.createElement('h1', { 
                style: { 
                    fontSize: '32px', 
                    marginBottom: '20px',
                    color: '#1DB954'
                } 
            }, 'Firebase Auth Test - v14 Safari Fix'),
            
            // Sign-in status
            React.createElement('div', {
                style: {
                    padding: '20px',
                    background: firebaseUser ? 'rgba(29, 185, 84, 0.2)' : 'rgba(220, 38, 38, 0.2)',
                    border: `1px solid ${firebaseUser ? '#1DB954' : '#dc2626'}`,
                    borderRadius: '12px',
                    marginBottom: '20px',
                    textAlign: 'center',
                    minWidth: '300px'
                }
            },
                React.createElement('div', { 
                    style: { fontSize: '18px', fontWeight: 'bold', marginBottom: '10px' } 
                }, firebaseUser ? '‚úÖ Signed In' : '‚ùå Not Signed In'),
                
                firebaseUser && React.createElement('div', { style: { fontSize: '14px' } },
                    React.createElement('div', {}, `UID: ${firebaseUser.uid}`),
                    React.createElement('div', {}, `Email: ${firebaseUser.email}`),
                    React.createElement('div', {}, `Name: ${firebaseUser.displayName}`)
                )
            ),
            
            // Buttons
            !firebaseUser ? (
                React.createElement('button', {
                    onClick: signInWithGoogle,
                    className: 'btn-primary'
                }, 'üîê Sign In with Google (Safari-Compatible)')
            ) : (
                React.createElement('button', {
                    onClick: async () => {
                        await firebaseAuth.signOut();
                        setFirebaseUser(null);
                        alert('‚úÖ Signed out!');
                    },
                    className: 'btn-primary',
                    style: { background: '#dc2626' }
                }, 'üö™ Sign Out')
            ),
            
            // Debug panel
            React.createElement('div', { className: 'debug-panel' },
                React.createElement('div', { 
                    style: { 
                        fontSize: '16px', 
                        fontWeight: 'bold', 
                        marginBottom: '15px',
                        color: '#1DB954'
                    } 
                }, 'üîß DEBUG INFO'),
                
                Object.entries(debugInfo).map(([key, value]) => 
                    React.createElement('div', { 
                        key: key,
                        className: 'debug-item'
                    }, `${key}: ${JSON.stringify(value)}`)
                )
            ),
            
            // Instructions
            React.createElement('div', {
                style: {
                    marginTop: '30px',
                    padding: '20px',
                    background: 'rgba(255, 255, 255, 0.05)',
                    borderRadius: '12px',
                    maxWidth: '600px',
                    fontSize: '14px',
                    lineHeight: '1.6'
                }
            },
                React.createElement('div', { 
                    style: { fontWeight: 'bold', marginBottom: '10px' } 
                }, 'üì± Safari Testing Instructions:'),
                React.createElement('div', {}, '1. Click "Sign In with Google"'),
                React.createElement('div', {}, '2. You will be redirected to Google'),
                React.createElement('div', {}, '3. Sign in with your Google account'),
                React.createElement('div', {}, '4. You will be redirected back to this page'),
                React.createElement('div', {}, '5. Check if the status shows "‚úÖ Signed In"'),
                React.createElement('div', { style: { marginTop: '10px', opacity: 0.8 } }, 
                    '‚ö†Ô∏è The page will reload after sign-in - this is normal!'
                )
            )
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(TestApp));
</script>

</body>
</html>
